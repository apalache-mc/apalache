<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Checking Pluscal specifications - Apalache Documentation</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Overview</a></li><li class="chapter-item expanded affix "><li class="part-title">Tutorials</li><li class="chapter-item expanded "><a href="../tutorials/index.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../tutorials/entry-tutorial.html"><strong aria-hidden="true">2.</strong> Entry-level Model Checker Tutorial</a></li><li class="chapter-item expanded "><a href="../tutorials/snowcat-tutorial.html"><strong aria-hidden="true">3.</strong> Type Checker Tutorial</a></li><li class="chapter-item expanded "><a href="../tutorials/pluscal-tutorial.html" class="active"><strong aria-hidden="true">4.</strong> Checking Pluscal specifications</a></li><li class="chapter-item expanded "><a href="../tutorials/trail-tips.html"><strong aria-hidden="true">5.</strong> Apalache trail tips: how to check your specs faster</a></li><li class="chapter-item expanded "><a href="../tutorials/symbmc.html"><strong aria-hidden="true">6.</strong> Symbolic Model Checking</a></li><li class="chapter-item expanded affix "><li class="part-title">Apalache User Manual</li><li class="chapter-item expanded "><a href="../apalache/index.html"><strong aria-hidden="true">7.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../apalache/installation/index.html"><strong aria-hidden="true">7.1.</strong> Installation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../apalache/installation/jvm.html"><strong aria-hidden="true">7.1.1.</strong> Prebuilt Packages</a></li><li class="chapter-item expanded "><a href="../apalache/installation/docker.html"><strong aria-hidden="true">7.1.2.</strong> Docker</a></li><li class="chapter-item expanded "><a href="../apalache/installation/source.html"><strong aria-hidden="true">7.1.3.</strong> Build from Source</a></li></ol></li><li class="chapter-item expanded "><a href="../apalache/running.html"><strong aria-hidden="true">7.2.</strong> Running the Tool</a></li><li class="chapter-item expanded "><a href="../apalache/example.html"><strong aria-hidden="true">7.3.</strong> An Example TLA+ Specification</a></li><li class="chapter-item expanded "><a href="../apalache/parameters.html"><strong aria-hidden="true">7.4.</strong> Specification Parameters</a></li><li class="chapter-item expanded "><a href="../apalache/principles/index.html"><strong aria-hidden="true">7.5.</strong> Symbolic Model Checking with Apalache</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../apalache/principles/assignments.html"><strong aria-hidden="true">7.5.1.</strong> Assignments and symbolic transitions</a></li><li class="chapter-item expanded "><a href="../apalache/principles/folds.html"><strong aria-hidden="true">7.5.2.</strong> Folding sets and sequences</a></li><li class="chapter-item expanded "><a href="../apalache/principles/invariants.html"><strong aria-hidden="true">7.5.3.</strong> Invariants: State, Action, Trace</a></li><li class="chapter-item expanded "><a href="../apalache/principles/enumeration.html"><strong aria-hidden="true">7.5.4.</strong> Enumeration of counterexamples</a></li><li class="chapter-item expanded "><a href="../apalache/principles/apalache-mod.html"><strong aria-hidden="true">7.5.5.</strong> The Apalache Module</a></li><li class="chapter-item expanded "><a href="../apalache/principles/naturals.html"><strong aria-hidden="true">7.5.6.</strong> Naturals</a></li></ol></li><li class="chapter-item expanded "><a href="../apalache/config.html"><strong aria-hidden="true">7.6.</strong> Apalache global configuration file</a></li><li class="chapter-item expanded "><a href="../apalache/statistics.html"><strong aria-hidden="true">7.7.</strong> TLA+ Execution Statistics</a></li><li class="chapter-item expanded "><a href="../apalache/profiling.html"><strong aria-hidden="true">7.8.</strong> Profiling Your Specification</a></li><li class="chapter-item expanded "><a href="../apalache/theory.html"><strong aria-hidden="true">7.9.</strong> Five minutes of theory</a></li></ol></li><li class="chapter-item expanded "><a href="../apalache/tlc-config.html"><strong aria-hidden="true">8.</strong> TLC Configuration Files</a></li><li class="chapter-item expanded "><a href="../apalache/typechecker-snowcat.html"><strong aria-hidden="true">9.</strong> The Snowcat Type Checker</a></li><li class="chapter-item expanded "><a href="../apalache/features.html"><strong aria-hidden="true">10.</strong> Supported Features</a></li><li class="chapter-item expanded "><a href="../apalache/principles/recursive.html"><strong aria-hidden="true">11.</strong> Obsolete: Recursive operators and functions</a></li><li class="chapter-item expanded "><a href="../apalache/known-issues.html"><strong aria-hidden="true">12.</strong> Known Issues</a></li><li class="chapter-item expanded "><a href="../apalache/antipatterns.html"><strong aria-hidden="true">13.</strong> Antipatterns</a></li><li class="chapter-item expanded "><a href="../apalache/preprocessing.html"><strong aria-hidden="true">14.</strong> TLA+ Preprocessing</a></li><li class="chapter-item expanded "><a href="../apalache/tuning.html"><strong aria-hidden="true">15.</strong> Fine Tuning</a></li><li class="chapter-item expanded "><a href="../apalache/assignments-in-depth.html"><strong aria-hidden="true">16.</strong> Assignments and Symbolic Transitions in Depth</a></li><li class="chapter-item expanded "><a href="../apalache/kera.html"><strong aria-hidden="true">17.</strong> KerA: kernel logic of actions</a></li><li class="chapter-item expanded affix "><li class="part-title">HOWTOs</li><li class="chapter-item expanded "><a href="../HOWTOs/index.html"><strong aria-hidden="true">18.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../HOWTOs/howto-write-type-annotations.html"><strong aria-hidden="true">19.</strong> How to write type annotations</a></li><li class="chapter-item expanded "><a href="../HOWTOs/uninterpretedTypes.html"><strong aria-hidden="true">20.</strong> How to use uninterpreted types</a></li><li class="chapter-item expanded affix "><li class="part-title">TLA+ Language Manual for Engineers</li><li class="chapter-item expanded "><a href="../lang/index.html"><strong aria-hidden="true">21.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../lang/standard-operators.html"><strong aria-hidden="true">22.</strong> The standard operators of TLA+</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../lang/booleans.html"><strong aria-hidden="true">22.1.</strong> Booleans</a></li><li class="chapter-item expanded "><a href="../lang/control-and-nondeterminism.html"><strong aria-hidden="true">22.2.</strong> Control And Nondeterminism</a></li><li class="chapter-item expanded "><a href="../lang/conditionals.html"><strong aria-hidden="true">22.3.</strong> Conditionals</a></li><li class="chapter-item expanded "><a href="../lang/integers.html"><strong aria-hidden="true">22.4.</strong> Integers</a></li><li class="chapter-item expanded "><a href="../lang/sets.html"><strong aria-hidden="true">22.5.</strong> Sets</a></li><li class="chapter-item expanded "><a href="../lang/logic.html"><strong aria-hidden="true">22.6.</strong> Logic</a></li><li class="chapter-item expanded "><a href="../lang/functions.html"><strong aria-hidden="true">22.7.</strong> Functions</a></li><li class="chapter-item expanded "><a href="../lang/records.html"><strong aria-hidden="true">22.8.</strong> Records</a></li><li class="chapter-item expanded "><a href="../lang/tuples.html"><strong aria-hidden="true">22.9.</strong> Tuples</a></li><li class="chapter-item expanded "><a href="../lang/sequences.html"><strong aria-hidden="true">22.10.</strong> Sequences</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">22.11.</strong> Bags</div></li></ol></li><li class="chapter-item expanded "><a href="../lang/user-operators.html"><strong aria-hidden="true">23.</strong> User-defined operators</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../lang/user/top-level-operators.html"><strong aria-hidden="true">23.1.</strong> Top-level operator definitions</a></li><li class="chapter-item expanded "><a href="../lang/user/let-in.html"><strong aria-hidden="true">23.2.</strong> LET-IN definitions</a></li><li class="chapter-item expanded "><a href="../lang/user/higher-order-operators.html"><strong aria-hidden="true">23.3.</strong> Higher-order operators definitions</a></li><li class="chapter-item expanded "><a href="../lang/user/lambdas.html"><strong aria-hidden="true">23.4.</strong> Anonymous operator definitions</a></li><li class="chapter-item expanded "><a href="../lang/user/local-operators.html"><strong aria-hidden="true">23.5.</strong> Local operator definitions</a></li></ol></li><li class="chapter-item expanded "><a href="../lang/apalache-operators.html"><strong aria-hidden="true">24.</strong> Apalache operators</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">25.</strong> Modules, Extends, and Instances</div></li><li class="chapter-item expanded affix "><li class="part-title">Idiomatic TLA+</li><li class="chapter-item expanded "><a href="../idiomatic/index.html"><strong aria-hidden="true">26.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../idiomatic/000keep-minimum-state-variables.html"><strong aria-hidden="true">27.</strong> Keep state variables to the minimum</a></li><li class="chapter-item expanded "><a href="../idiomatic/001assignments.html"><strong aria-hidden="true">28.</strong> Update state variables with assignments</a></li><li class="chapter-item expanded "><a href="../idiomatic/002primes.html"><strong aria-hidden="true">29.</strong> Apply primes only to state variables</a></li><li class="chapter-item expanded "><a href="../idiomatic/007if-then-else.html"><strong aria-hidden="true">30.</strong> Use Boolean operators in actions, not IF-THEN-ELSE</a></li><li class="chapter-item expanded "><a href="../idiomatic/003record-sets.html"><strong aria-hidden="true">31.</strong> Avoid sets of mixed records</a></li><li class="chapter-item expanded affix "><li class="part-title">Design Documents</li><li class="chapter-item expanded "><a href="../adr/002adr-types.html"><strong aria-hidden="true">32.</strong> ADR-002: types and type annotations</a></li><li class="chapter-item expanded "><a href="../adr/003adr-trex.html"><strong aria-hidden="true">33.</strong> ADR-003: transition executor (TRex)</a></li><li class="chapter-item expanded "><a href="../adr/004adr-annotations.html"><strong aria-hidden="true">34.</strong> ADR-004: code annotations</a></li><li class="chapter-item expanded "><a href="../adr/005adr-json.html"><strong aria-hidden="true">35.</strong> ADR-005: JSON Serialization Format</a></li><li class="chapter-item expanded "><a href="../adr/006rfc-unit-testing.html"><strong aria-hidden="true">36.</strong> RFC-006: unit tests and property-based tests</a></li><li class="chapter-item expanded "><a href="../adr/007adr-restructuring.html"><strong aria-hidden="true">37.</strong> ADR-007: restructuring</a></li><li class="chapter-item expanded "><a href="../adr/008adr-exceptions.html"><strong aria-hidden="true">38.</strong> ADR-008: exceptions</a></li><li class="chapter-item expanded "><a href="../adr/009adr-outputs.html"><strong aria-hidden="true">39.</strong> ADR-009: outputs</a></li><li class="chapter-item expanded "><a href="../adr/011adr-smt-arrays.html"><strong aria-hidden="true">40.</strong> ADR-011: alternative SMT encoding using arrays</a></li><li class="chapter-item expanded "><a href="../adr/015adr-trace.html"><strong aria-hidden="true">41.</strong> ADR-015: ITF: informal trace format</a></li><li class="chapter-item expanded "><a href="../adr/016adr-retla.html"><strong aria-hidden="true">42.</strong> ADR-016: ReTLA: Relational TLA</a></li><li class="chapter-item expanded "><a href="../adr/017pdr-temporal.html"><strong aria-hidden="true">43.</strong> PDR-017: Checking temporal properties</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Apalache Documentation</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/informalsystems/apalache" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#tutorial-on-checking-pluscal-specifications-with-apalache" id="tutorial-on-checking-pluscal-specifications-with-apalache">Tutorial on checking PlusCal specifications with Apalache</a></h1>
<p><strong>Difficulty: Blue trail â€“ Easy</strong></p>
<p>In this short tutorial, we show how to annotate a <a href="https://github.com/tlaplus/Examples/blob/master/specifications/Bakery-Boulangerie/Bakery.tla">PlusCal specification</a> of
the Bakery algorithm, to check it with Apalache. In particular, we check mutual
exclusion by <em>bounded model checking</em> (which considers only bounded executions).
Moreover, we automatically prove mutual exclusion for unbounded executions by
<em>induction</em>.</p>
<p>We only focus on the part
related to Apalache. If you want to understand the Bakery algorithm and its
specification, check the comments in the original <a href="https://github.com/tlaplus/Examples/blob/master/specifications/Bakery-Boulangerie/Bakery.tla">PlusCal specification</a>.</p>
<h2><a class="header" href="#setup" id="setup">Setup</a></h2>
<p>We assume that you have Apalache installed. If not, check the manual page on
<a href="../apalache/installation/index.html">Apalache installation</a>. The minimal required version is 0.22.0.</p>
<h2><a class="header" href="#running-example-bakery" id="running-example-bakery">Running example: Bakery</a></h2>
<p>We start with the <a href="https://github.com/tlaplus/Examples/blob/master/specifications/Bakery-Boulangerie/Bakery.tla">PlusCal specification</a> of the <a href="https://en.wikipedia.org/wiki/Lamport%27s_bakery_algorithm">Bakery algorithm</a>. This
specification has been checked with the model checker <a href="https://github.com/tlaplus/tlaplus/">TLC</a>.  Moreover,
<a href="https://lamport.azurewebsites.net/">Leslie Lamport</a> has proved safety of this algorithm with the <a href="https://tla.msr-inria.inria.fr/tlaps/content/Home.html">TLAPS</a>.</p>
<h2><a class="header" href="#step-0-remove-the-tlaps-proof" id="step-0-remove-the-tlaps-proof">Step 0: Remove the TLAPS proof</a></h2>
<p>Since we are not interested in the TLAPS proof, we copy <a href="https://github.com/tlaplus/Examples/blob/master/specifications/Bakery-Boulangerie/Bakery.tla">Bakery.tla</a> to
<a href="https://github.com/informalsystems/apalache/blob/unstable/test/tla/bakery-pluscal/BakeryWoTlaps.tla">BakeryWoTlaps.tla</a> and modify it as follows:</p>
<ul>
<li>
<p>Remove <code>TLAPS</code> from the list of extended modules</p>
<pre><code class="language-tla">EXTENDS Naturals
</code></pre>
</li>
<li>
<p>Remove the theorem and its proof:</p>
<pre><code class="language-tla">THEOREM Spec =&gt; []MutualExclusion
...
</code></pre>
</li>
</ul>
<h2><a class="header" href="#step-1-add-a-module-with-type-annotations" id="step-1-add-a-module-with-type-annotations">Step 1: Add a module with type annotations</a></h2>
<p>Let us check the types of <a href="https://github.com/informalsystems/apalache/blob/unstable/test/tla/bakery-pluscal/BakeryWoTlaps.tla">BakeryWoTlaps.tla</a> with Apalache:</p>
<pre><code class="language-sh">$ apalache-mc typecheck BakeryWoTlaps.tla
...
Typing input error: Expected a type annotation for VARIABLE max
</code></pre>
<p>The type checker complains about missing type annotations. See the <a href="./snowcat-tutorial.html">Tutorial on
Snowcat</a> for details. When we try to add type annotations to the variables,
we run into an issue. Indeed, the variables are declared with the PlusCal
syntax:</p>
<pre><code class="language-tla">--algorithm Bakery 
{ variables num = [i \in Procs |-&gt; 0], flag = [i \in Procs |-&gt; FALSE];
  fair process (p \in Procs)
    variables unchecked = {}, max = 0, nxt = 1 ;
</code></pre>
<p>The most straightforward approach would be to add type annotations directly in
the PlusCal code. As reported in <a href="https://github.com/informalsystems/apalache/issues/1412">Issue 1412</a>, this does not work as
expected, as the PlusCal translator erases the comments.</p>
<p>A simple solution is to add type annotations directly to the declarations in
the generated TLA+ code. However, this solution is fragile. If we change the
PlusCal code, our annotations will get overridden. We propose another solution
that is stable under modification of the PlusCal code. To this end, we
introduce a new module called <code>BakeryTyped.tla</code> with the following contents:</p>
<pre><code class="language-tla">-------------------------- MODULE BakeryTyped --------------------------------

CONSTANT
    \* @type: Int;
    N

VARIABLES
    \* @type: Int -&gt; Int;
    num,
    \* @type: Int -&gt; Bool;
    flag,
    \* @type: Int -&gt; Str;
    pc,
    \* @type: Int -&gt; Set(Int);
    unchecked,
    \* @type: Int -&gt; Int;
    max,
    \* @type: Int -&gt; Int;
    nxt

ConstInit4 ==
    N = 4

INSTANCE BakeryWoTlaps
==============================================================================

</code></pre>
<p>Due to the semantics of <code>INSTANCE</code>, the constants and variables declared in
<code>BakeryTyped.tla</code> substitute the constants and variables of
<code>BakeryWoTlaps.tla</code>. By doing so we effectively introduce type annotations.
Since we introduce a separate module, any changes in the PlusCal code do not
affect our type annotations.</p>
<p>Additionally, we add a constant initializer <code>ConstInit4</code>, which we will use
later. See the manual section about the <a href="../apalache/parameters.html#constinit-predicate">ConstInit predicate</a> for a detailed
explanation.</p>
<h2><a class="header" href="#step-2-annotate-the-operator-prec" id="step-2-annotate-the-operator-prec">Step 2: Annotate the operator <code>\prec</code></a></h2>
<p>Let us run the type checker against <code>BakeryTyped.tla</code>:</p>
<pre><code class="language-sh">$ apalache-mc typecheck BakeryTyped.tla
...
[BakeryWoTlaps.tla:66:17-66:20]: Cannot apply a to the argument 1 in a[1].
...
</code></pre>
<p>The type checker complains about types of <code>a</code> and <code>b</code> in the operator <code>\prec</code>:</p>
<pre><code class="language-tla">a \prec b == \/ a[1] &lt; b[1]
             \/ (a[1] = b[1]) /\ (a[2] &lt; b[2])
</code></pre>
<p>The issue is that the type checker is not able to decide whether <code>a</code> and <code>b</code>
are functions, sequences, or tuples. We help the type checker by adding type
annotations to the operator <code>\preceq</code>.</p>
<pre><code class="language-tla">\* A type annotation introduced for Apalache:
\*
\* @type: (&lt;&lt;Int, Int&gt;&gt;, &lt;&lt;Int, Int&gt;&gt;) =&gt; Bool;
a \prec b == \/ a[1] &lt; b[1]
             \/ (a[1] = b[1]) /\ (a[2] &lt; b[2])
</code></pre>
<p>When we run the type checker once again, it computes all types without
any problem:</p>
<pre><code class="language-sh">$ apalache-mc typecheck BakeryTyped.tla
...
Type checker [OK]
</code></pre>
<p>Note that our annotation of <code>\preceq</code> would not get overwritten, when we update
the PlusCal code. This is because <code>\preceq</code> is defined in the TLA+ section.</p>
<h2><a class="header" href="#step-3-checking-mutual-exclusion-for-bounded-executions" id="step-3-checking-mutual-exclusion-for-bounded-executions">Step 3: Checking mutual exclusion for bounded executions</a></h2>
<p>Once we have annotations, we run Apalache to check the property of mutual
exclusion for four processes and executions of length up to 10 steps:</p>
<pre><code class="language-sh">$ apalache-mc apalache-mc check \
    --cinit=ConstInit4 --inv=MutualExclusion BakeryTyped.tla
...
It took me 0 days  0 hours 32 min  2 sec
</code></pre>
<p>Apalache reports no violation of <code>MutualExclusion</code>. This is a good start.
However, since Apalache only analyzes executions that make up to 10
transitions by default, this analysis is incomplete.</p>
<h2><a class="header" href="#step-4-checking-mutual-exclusion-for-unbounded-executions" id="step-4-checking-mutual-exclusion-for-unbounded-executions">Step 4: Checking mutual exclusion for unbounded executions</a></h2>
<p>To analyze executions of arbitrary length with Apalache, we can check an
inductive invariant. For details, see the section on <a href="https://apalache.informal.systems/docs/apalache/running.html#checking-an-inductive-invariant">Checking inductive
invariants</a>. The Bakery specification contains such an invariant written by
Leslie Lamport:</p>
<pre><code class="language-tla">(***************************************************************************)
(* Inv is the complete inductive invariant.                                *)
(***************************************************************************)  
Inv == /\ TypeOK 
       /\ \A i \in Procs : 
             /\ (pc[i] \in {&quot;e4&quot;, &quot;w1&quot;, &quot;w2&quot;, &quot;cs&quot;}) =&gt; (num[i] # 0)
             /\ (pc[i] \in {&quot;e2&quot;, &quot;e3&quot;}) =&gt; flag[i] 
             /\ (pc[i] = &quot;w2&quot;) =&gt; (nxt[i] # i)
             /\ pc[i] \in {(*&quot;e2&quot;,*) &quot;w1&quot;, &quot;w2&quot;} =&gt; i \notin unchecked[i]
             /\ (pc[i] \in {&quot;w1&quot;, &quot;w2&quot;}) =&gt;
                   \A j \in (Procs \ unchecked[i]) \ {i} : Before(i, j)
             /\ /\ (pc[i] = &quot;w2&quot;)
                /\ \/ (pc[nxt[i]] = &quot;e2&quot;) /\ (i \notin unchecked[nxt[i]])
                   \/ pc[nxt[i]] = &quot;e3&quot;
                =&gt; max[nxt[i]] &gt;= num[i]
             /\ (pc[i] = &quot;cs&quot;) =&gt; \A j \in Procs \ {i} : Before(i, j)

-----------------------------------------------------------------------------
</code></pre>
<p>To prove that <code>Inv</code> is an inductive invariant for <code>N = 4</code>, we run Apalache
twice. First, we check that the initial states satisfy the invariant <code>Inv</code>:</p>
<pre><code class="language-sh">$ apalache-mc apalache-mc check --cinit=ConstInit4 \
    --init=Init --inv=Inv --length=0 BakeryTyped.tla
...
The outcome is: NoError
It took me 0 days  0 hours  0 min  6 sec
</code></pre>
<p>Second, we check that for every state that satisfies <code>Inv</code>, the following
holds true: Its successors via <code>Next</code> satisfy <code>Inv</code> too. This is done as
follows:</p>
<pre><code class="language-sh">$ apalache-mc apalache-mc check --cinit=ConstInit4 \
    --init=Inv --inv=Inv --length=1 BakeryTyped.tla
...
The outcome is: NoError
It took me 0 days  0 hours  0 min 28 sec
</code></pre>
<p>Now we know that <code>Inv</code> is indeed an inductive invariant. Hence, we check
the property <code>MutualExclusion</code> against the states that satisfy <code>Inv</code>:</p>
<pre><code class="language-sh">$ apalache-mc apalache-mc check --cinit=ConstInit4 \
    --init=Inv --inv=MutualExclusion --length=0 BakeryTyped.tla
...
The outcome is: NoError
It took me 0 days  0 hours  0 min 9 sec
</code></pre>
<p>In particular, these three results allow us to conclude that <code>MutualExclusion</code>
holds for all states that are reachable from the initial states (satisfying
<code>Init</code>) via the available transitions (satisfying <code>Next</code>). Since we have fixed
the constant <code>N</code> with the predicate <code>ConstInit4</code>, this result holds true for <code>N = 4</code>. If you want to check <code>MutualExclusion</code> for other values of <code>N</code>, you can
define a predicate similar to <code>ConstInit4</code>. We cannot check the invariant for
all values of <code>N</code>, as this would require Apalache to reason about unbounded
sets and functions, which is currently not supported.</p>
<h2><a class="header" href="#dealing-with-the-define-block" id="dealing-with-the-define-block">Dealing with the define block</a></h2>
<p>PlusCal specifications may contain the special define-block. For example:</p>
<pre><code class="language-tla">---- MODULE CountersPluscal ----

(*
  Pluscal code inside TLA+ code.

--algorithm Counters {
  variable x = 0;

  define {
    \* This is TLA+ code inside the PlusCal code.
    IsPositive(x) == x &gt; 0
  }

  ...
}
*)
================================
</code></pre>
<p>Unfortunately, the PlusCal transpiler erases comments when translating PlusCal
code to TLA+. Hence, the simplest solution is to move the define-block outside
the PlusCal code. For example:</p>
<pre><code class="language-tla">---- MODULE CountersPluscal ----

\* @type: Int =&gt; Bool;
IsPositive(x) == x &gt; 0

(*
--algorithm Counters {
  variable x = 0;

  ...
}
*)
================================
</code></pre>
<h2><a class="header" href="#conclusion" id="conclusion">Conclusion</a></h2>
<p>The final specifications can be found in
<a href="https://github.com/informalsystems/apalache/blob/unstable/test/tla/bakery-pluscal/BakeryTyped.tla">BakeryTyped.tla</a>
and
<a href="https://github.com/informalsystems/apalache/blob/unstable/test/tla/bakery-pluscal/BakeryWoTlaps.tla">BakeryWoTlaps.tla</a>.</p>
<p>In this tutorial we have shown how to:</p>
<ul>
<li>Annotate a PlusCal spec with types by introducing an additional TLA+ module.</li>
<li>Check safety of Bakery for bounded executions by bounded model checking (for
<code>N=4</code>).</li>
<li>Check safety of Bakery for unbounded executions by invariant checking (for
<code>N=4</code>).</li>
</ul>
<p>If you are experiencing a problem with Apalache, feel free to <a href="https://github.com/informalsystems/apalache/issues">open an issue</a>
or drop us a message on <a href="https://informal-systems.zulipchat.com/login/#narrow/stream/265309-apalache">Zulip chat</a>.</p>
<h2><a class="header" href="#further-reading" id="further-reading">Further reading</a></h2>
<ul>
<li><a href="./entry-tutorial.html">Entry-level Tutorial on the Model Checker</a></li>
<li><a href="./snowcat-tutorial.html">Tutorial on Snowcat</a> shows how to write type annotations for Apalache.</li>
<li><a href="https://mbt.informal.systems/docs/tla_basics_tutorials/tla+cheatsheet.html">TLA+ Cheatsheet in HTML</a> summarizes the common TLA+ constructs. If you
prefer a printable version in pdf, check the <a href="https://lamport.azurewebsites.net/tla/summary-standalone.pdf">Summary of TLA+</a>.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../tutorials/snowcat-tutorial.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../tutorials/trail-tips.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../tutorials/snowcat-tutorial.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../tutorials/trail-tips.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
