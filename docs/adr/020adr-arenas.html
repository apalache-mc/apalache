<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ADR-020: Improving membership in arenas - Apalache Documentation</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Overview</a></li><li class="chapter-item expanded affix "><li class="part-title">Tutorials</li><li class="chapter-item expanded "><a href="../tutorials/index.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../tutorials/entry-tutorial.html"><strong aria-hidden="true">2.</strong> Entry-level Model Checker Tutorial</a></li><li class="chapter-item expanded "><a href="../tutorials/snowcat-tutorial.html"><strong aria-hidden="true">3.</strong> Type Checker Tutorial</a></li><li class="chapter-item expanded "><a href="../tutorials/pluscal-tutorial.html"><strong aria-hidden="true">4.</strong> Checking Pluscal specifications</a></li><li class="chapter-item expanded "><a href="../tutorials/trail-tips.html"><strong aria-hidden="true">5.</strong> Apalache trail tips: how to check your specs faster</a></li><li class="chapter-item expanded "><a href="../tutorials/symbmc.html"><strong aria-hidden="true">6.</strong> Symbolic Model Checking</a></li><li class="chapter-item expanded "><a href="../tutorials/temporal-properties.html"><strong aria-hidden="true">7.</strong> Specifying temporal properties and understanding counterexamples</a></li><li class="chapter-item expanded affix "><li class="part-title">HOWTOs</li><li class="chapter-item expanded "><a href="../HOWTOs/index.html"><strong aria-hidden="true">8.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../HOWTOs/howto-write-type-annotations.html"><strong aria-hidden="true">9.</strong> How to write type annotations</a></li><li class="chapter-item expanded "><a href="../HOWTOs/uninterpretedTypes.html"><strong aria-hidden="true">10.</strong> How to use uninterpreted types</a></li><li class="chapter-item expanded affix "><li class="part-title">Apalache User Manual</li><li class="chapter-item expanded "><a href="../apalache/index.html"><strong aria-hidden="true">11.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../apalache/installation/index.html"><strong aria-hidden="true">11.1.</strong> Installation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../apalache/installation/jvm.html"><strong aria-hidden="true">11.1.1.</strong> Prebuilt Packages</a></li><li class="chapter-item expanded "><a href="../apalache/installation/docker.html"><strong aria-hidden="true">11.1.2.</strong> Docker</a></li><li class="chapter-item expanded "><a href="../apalache/installation/source.html"><strong aria-hidden="true">11.1.3.</strong> Build from Source</a></li></ol></li><li class="chapter-item expanded "><a href="../apalache/running.html"><strong aria-hidden="true">11.2.</strong> Running the Tool</a></li><li class="chapter-item expanded "><a href="../apalache/example.html"><strong aria-hidden="true">11.3.</strong> An Example TLA+ Specification</a></li><li class="chapter-item expanded "><a href="../apalache/parameters.html"><strong aria-hidden="true">11.4.</strong> Specification Parameters</a></li><li class="chapter-item expanded "><a href="../apalache/principles/index.html"><strong aria-hidden="true">11.5.</strong> Symbolic Model Checking with Apalache</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../apalache/principles/assignments.html"><strong aria-hidden="true">11.5.1.</strong> Assignments and symbolic transitions</a></li><li class="chapter-item expanded "><a href="../apalache/principles/folds.html"><strong aria-hidden="true">11.5.2.</strong> Folding sets and sequences</a></li><li class="chapter-item expanded "><a href="../apalache/principles/invariants.html"><strong aria-hidden="true">11.5.3.</strong> Invariants: State, Action, Trace</a></li><li class="chapter-item expanded "><a href="../apalache/principles/enumeration.html"><strong aria-hidden="true">11.5.4.</strong> Enumeration of counterexamples</a></li><li class="chapter-item expanded "><a href="../apalache/principles/apalache-mod.html"><strong aria-hidden="true">11.5.5.</strong> The Apalache Module</a></li><li class="chapter-item expanded "><a href="../apalache/principles/naturals.html"><strong aria-hidden="true">11.5.6.</strong> Naturals</a></li></ol></li><li class="chapter-item expanded "><a href="../apalache/config.html"><strong aria-hidden="true">11.6.</strong> Apalache global configuration file</a></li><li class="chapter-item expanded "><a href="../apalache/statistics.html"><strong aria-hidden="true">11.7.</strong> TLA+ Execution Statistics</a></li><li class="chapter-item expanded "><a href="../apalache/profiling.html"><strong aria-hidden="true">11.8.</strong> Profiling Your Specification</a></li><li class="chapter-item expanded "><a href="../apalache/theory.html"><strong aria-hidden="true">11.9.</strong> Five minutes of theory</a></li></ol></li><li class="chapter-item expanded "><a href="../apalache/tuning.html"><strong aria-hidden="true">12.</strong> Fine Tuning</a></li><li class="chapter-item expanded "><a href="../apalache/tlc-config.html"><strong aria-hidden="true">13.</strong> TLC Configuration Files</a></li><li class="chapter-item expanded "><a href="../apalache/typechecker-snowcat.html"><strong aria-hidden="true">14.</strong> The Snowcat Type Checker</a></li><li class="chapter-item expanded "><a href="../apalache/features.html"><strong aria-hidden="true">15.</strong> Supported Features</a></li><li class="chapter-item expanded "><a href="../apalache/principles/recursive.html"><strong aria-hidden="true">16.</strong> Obsolete: Recursive operators and functions</a></li><li class="chapter-item expanded "><a href="../apalache/known-issues.html"><strong aria-hidden="true">17.</strong> Known Issues</a></li><li class="chapter-item expanded "><a href="../apalache/antipatterns.html"><strong aria-hidden="true">18.</strong> Antipatterns</a></li><li class="chapter-item expanded "><a href="../apalache/preprocessing.html"><strong aria-hidden="true">19.</strong> TLA+ Preprocessing</a></li><li class="chapter-item expanded "><a href="../apalache/assignments-in-depth.html"><strong aria-hidden="true">20.</strong> Assignments and Symbolic Transitions in Depth</a></li><li class="chapter-item expanded "><a href="../apalache/kera.html"><strong aria-hidden="true">21.</strong> KerA: kernel logic of actions</a></li><li class="chapter-item expanded affix "><li class="part-title">TLA+ Language Manual for Engineers</li><li class="chapter-item expanded "><a href="../lang/index.html"><strong aria-hidden="true">22.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../lang/standard-operators.html"><strong aria-hidden="true">23.</strong> The standard operators of TLA+</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../lang/booleans.html"><strong aria-hidden="true">23.1.</strong> Booleans</a></li><li class="chapter-item expanded "><a href="../lang/control-and-nondeterminism.html"><strong aria-hidden="true">23.2.</strong> Control And Nondeterminism</a></li><li class="chapter-item expanded "><a href="../lang/conditionals.html"><strong aria-hidden="true">23.3.</strong> Conditionals</a></li><li class="chapter-item expanded "><a href="../lang/integers.html"><strong aria-hidden="true">23.4.</strong> Integers</a></li><li class="chapter-item expanded "><a href="../lang/sets.html"><strong aria-hidden="true">23.5.</strong> Sets</a></li><li class="chapter-item expanded "><a href="../lang/logic.html"><strong aria-hidden="true">23.6.</strong> Logic</a></li><li class="chapter-item expanded "><a href="../lang/functions.html"><strong aria-hidden="true">23.7.</strong> Functions</a></li><li class="chapter-item expanded "><a href="../lang/records.html"><strong aria-hidden="true">23.8.</strong> Records</a></li><li class="chapter-item expanded "><a href="../lang/tuples.html"><strong aria-hidden="true">23.9.</strong> Tuples</a></li><li class="chapter-item expanded "><a href="../lang/sequences.html"><strong aria-hidden="true">23.10.</strong> Sequences</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">23.11.</strong> Bags</div></li></ol></li><li class="chapter-item expanded "><a href="../lang/apalache-extensions.html"><strong aria-hidden="true">24.</strong> Apalache extensions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../lang/apalache-operators.html"><strong aria-hidden="true">24.1.</strong> Apalache module</a></li><li class="chapter-item expanded "><a href="../lang/variants.html"><strong aria-hidden="true">24.2.</strong> Variants</a></li><li class="chapter-item expanded "><a href="../lang/option-types.html"><strong aria-hidden="true">24.3.</strong> Option types</a></li></ol></li><li class="chapter-item expanded "><a href="../lang/user-operators.html"><strong aria-hidden="true">25.</strong> User-defined operators</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../lang/user/top-level-operators.html"><strong aria-hidden="true">25.1.</strong> Top-level operator definitions</a></li><li class="chapter-item expanded "><a href="../lang/user/let-in.html"><strong aria-hidden="true">25.2.</strong> LET-IN definitions</a></li><li class="chapter-item expanded "><a href="../lang/user/higher-order-operators.html"><strong aria-hidden="true">25.3.</strong> Higher-order operators definitions</a></li><li class="chapter-item expanded "><a href="../lang/user/lambdas.html"><strong aria-hidden="true">25.4.</strong> Anonymous operator definitions</a></li><li class="chapter-item expanded "><a href="../lang/user/local-operators.html"><strong aria-hidden="true">25.5.</strong> Local operator definitions</a></li></ol></li><li class="chapter-item expanded "><a href="../lang/modules.html"><strong aria-hidden="true">26.</strong> Modules, Extends, and Instances</a></li><li class="chapter-item expanded affix "><li class="part-title">Idiomatic TLA+</li><li class="chapter-item expanded "><a href="../idiomatic/index.html"><strong aria-hidden="true">27.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../idiomatic/000keep-minimum-state-variables.html"><strong aria-hidden="true">28.</strong> Keep state variables to the minimum</a></li><li class="chapter-item expanded "><a href="../idiomatic/001assignments.html"><strong aria-hidden="true">29.</strong> Update state variables with assignments</a></li><li class="chapter-item expanded "><a href="../idiomatic/002primes.html"><strong aria-hidden="true">30.</strong> Apply primes only to state variables</a></li><li class="chapter-item expanded "><a href="../idiomatic/007if-then-else.html"><strong aria-hidden="true">31.</strong> Use Boolean operators in actions, not IF-THEN-ELSE</a></li><li class="chapter-item expanded "><a href="../idiomatic/003record-sets.html"><strong aria-hidden="true">32.</strong> Avoid sets of mixed records</a></li><li class="chapter-item expanded affix "><li class="part-title">Design Documents</li><li class="chapter-item expanded "><a href="../adr/001rfc-types.html"><strong aria-hidden="true">33.</strong> RFC 001: types and type annotations</a></li><li class="chapter-item expanded "><a href="../adr/002adr-types.html"><strong aria-hidden="true">34.</strong> ADR-002: types and type annotations</a></li><li class="chapter-item expanded "><a href="../adr/003adr-trex.html"><strong aria-hidden="true">35.</strong> ADR-003: transition executor (TRex)</a></li><li class="chapter-item expanded "><a href="../adr/004adr-annotations.html"><strong aria-hidden="true">36.</strong> ADR-004: code annotations</a></li><li class="chapter-item expanded "><a href="../adr/005adr-json.html"><strong aria-hidden="true">37.</strong> ADR-005: JSON Serialization Format</a></li><li class="chapter-item expanded "><a href="../adr/006rfc-unit-testing.html"><strong aria-hidden="true">38.</strong> RFC-006: unit tests and property-based tests</a></li><li class="chapter-item expanded "><a href="../adr/007adr-restructuring.html"><strong aria-hidden="true">39.</strong> ADR-007: restructuring</a></li><li class="chapter-item expanded "><a href="../adr/008adr-exceptions.html"><strong aria-hidden="true">40.</strong> ADR-008: exceptions</a></li><li class="chapter-item expanded "><a href="../adr/009adr-outputs.html"><strong aria-hidden="true">41.</strong> ADR-009: outputs</a></li><li class="chapter-item expanded "><a href="../adr/010rfc-transition-explorer.html"><strong aria-hidden="true">42.</strong> RFC-010: Implementation of Transition Exploration Server</a></li><li class="chapter-item expanded "><a href="../adr/011adr-smt-arrays.html"><strong aria-hidden="true">43.</strong> ADR-011: alternative SMT encoding using arrays</a></li><li class="chapter-item expanded "><a href="../adr/012adr-adopt-adr-template.html"><strong aria-hidden="true">44.</strong> ADR-012: Adopt an ADR Template</a></li><li class="chapter-item expanded "><a href="../adr/013adr-configuration.html"><strong aria-hidden="true">45.</strong> ADR-013: Configuration Management Component</a></li><li class="chapter-item expanded "><a href="../adr/014adr-precise-records.html"><strong aria-hidden="true">46.</strong> ADR-014: Precise type inference for records and variants</a></li><li class="chapter-item expanded "><a href="../adr/015adr-trace.html"><strong aria-hidden="true">47.</strong> ADR-015: ITF: informal trace format</a></li><li class="chapter-item expanded "><a href="../adr/016adr-retla.html"><strong aria-hidden="true">48.</strong> ADR-016: ReTLA: Relational TLA</a></li><li class="chapter-item expanded "><a href="../adr/017pdr-temporal.html"><strong aria-hidden="true">49.</strong> PDR-017: Checking temporal properties</a></li><li class="chapter-item expanded "><a href="../adr/018adr-inlining.html"><strong aria-hidden="true">50.</strong> ADR-018: Inlining in Apalache</a></li><li class="chapter-item expanded "><a href="../adr/019adr-harmonize-changelog.html"><strong aria-hidden="true">51.</strong> ADR-019: Harmonize changelog management</a></li><li class="chapter-item expanded "><a href="../adr/020adr-arenas.html" class="active"><strong aria-hidden="true">52.</strong> ADR-020: Improving membership in arenas</a></li><li class="chapter-item expanded "><a href="../adr/021rfc-prioritization.html"><strong aria-hidden="true">53.</strong> RFC-021: Prioritization of Work</a></li><li class="chapter-item expanded "><a href="../adr/022adr-unification-of-configs-and-options.html"><strong aria-hidden="true">54.</strong> ADR-022: Unify Configuration Management and &quot;Pass Options&quot;</a></li><li class="chapter-item expanded "><a href="../adr/023adr-trace-evaluation.html"><strong aria-hidden="true">55.</strong> ADR-023: Trace evaluation</a></li><li class="chapter-item expanded "><a href="../adr/024adr-arena-pass.html"><strong aria-hidden="true">56.</strong> ADR-024: Arena computation isolation</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Apalache Documentation</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/informalsystems/apalache" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#adr-020-introduce-static-membership-in-arenas" id="adr-020-introduce-static-membership-in-arenas">ADR-020: Introduce static membership in arenas</a></h1>
<table><thead><tr><th>authors</th><th align="right">last revised</th></tr></thead><tbody>
<tr><td>Igor Konnov</td><td align="right">2022-06-01</td></tr>
</tbody></table>
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#summary">Summary (Overview)</a></li>
<li><a href="#context">Context (Problem)</a></li>
<li><a href="#options">Options (Alternatives)</a></li>
<li><a href="#solution">Solution (Decision)</a></li>
<li><a href="#consequences">Consequences (Retrospection)</a></li>
</ul>
<h2><a class="header" href="#summary" id="summary">Summary</a></h2>
<p>We discuss an extension of the model checker arenas. The main application of this extension is a more efficient
implementation of powersets and functions sets. Potentially, this extension will let us optimize the number of SMT
constraints and thus improve performance of the model checker in general.</p>
<h2><a class="header" href="#1-context" id="1-context">1. Context</a></h2>
<p>We give only a brief introduction to arenas. A detailed exposition can be found in <a href="https://dl.acm.org/doi/10.1145/3360549">KKT19</a>.</p>
<h3><a class="header" href="#11-short-introduction-to-arenas" id="11-short-introduction-to-arenas">1.1. Short introduction to arenas</a></h3>
<p>The model checker heavily relies on the concept of arenas, which are a static overapproximation of the data structures
produced by symbolic execution of a TLA+ specification. Here we give a very short recap. In a nutshell, all basic values
of TLA+ (such as integers, strings, and Booleans) and data structures
(sets, functions, records, tuples, and sequences) are translated into <em>cells</em>. Cells are SMT constants, which can be
connected to other cells by <em>edges</em>. Currently, we have three kinds of edges:</p>
<ul>
<li>
<p><strong>has</strong>. A membership edge <code>(c_p, c_e)</code> represents that a parent cell <code>c_p</code>
potentially contains an element <code>c_e</code> (e.g., if <code>c_p</code> represents a set). These edges encode many-to-many relations.</p>
</li>
<li>
<p><strong>dom</strong>. A domain edge <code>(c_f, c_d)</code> represents that a function cell <code>c_f</code>
has the domain represented with a cell <code>c_d</code>. These edges encode many-to-one relations.</p>
<p>Likewise, a domain edge <code>(c_F, c_c)</code> represents that a function set cell
<code>c_F</code> has the domain represented with a cell <code>c_c</code>.</p>
</li>
<li>
<p><strong>cdm</strong>. A co-domain edge <code>(c_F, c_c)</code> represents that a function set cell
<code>c_F</code> has the co-domain represented with a cell <code>c_c</code>. These edges encode many-to-one relations.</p>
<p>For historic reasons, functions are also encoded with the edges called
<strong>dom</strong> and <strong>cdm</strong>, though the <strong>cdm</strong> edge points to the function relation, not its co-domain. We would prefer to
call label the relation edge with <strong>rel</strong>, not <strong>cdm</strong>. As these edges are many-to-one, we can map them from their
kinds <code>kind -&gt; (c_p, c_e)</code>. This requires simple refactoring, so we are not going to discuss the <strong>dom</strong> and <strong>cdm</strong>
any further.</p>
</li>
</ul>
<p>There is a need for refactoring and extension of the <strong>has</strong>-edges. We
summarize the issues with the current implementation of this kind of edges:</p>
<ul>
<li>
<p>Originally, every edge <code>(c_S, c_e)</code> of the kind <strong>has</strong> was encoded as a Boolean constant <code>in_${c_e.id}_${c_S.id}</code> in
SMT. Hence, every time we introduce a copy <code>c_T</code> of a set <code>c_S</code>, we introduce a new edge
<code>(c_T, c_e)</code> in the arena, and thus we have to introduce another Boolean constant <code>in_${c_e.id}_${c_T.id}</code> in SMT.
Alternatively, we could use a single Boolean variable both for <code>(c_S, c_e)</code> and <code>(c_T, c_e)</code>.</p>
</li>
<li>
<p>Later, when translating records and tuples, we stopped introducing Boolean constants in SMT for the <strong>has</strong>-edges.
However, we do not track in the arena the fact that these edges are presented only in the arena, not in SMT. Hence, we
have to be careful and avoid expressing membership in SMT when working with these edges.</p>
</li>
<li>
<p>As every <strong>has</strong>-edge directly refers to its parent in the edge name (that is, <code>in_${c_e.id}_${c_S.id}</code>), we cannot
share edges when encoding <code>SUBSET S</code> and <code>[S -&gt; T]</code>. As a result, we have to introduce a massive number of Boolean
constants and constraints, which are not necessary.</p>
</li>
<li>
<p>We keep adding edges and SMT constants to the solver context, even when we know exactly that an element belongs to a
set, e.g., as in <code>{ 1, 2, 3 }</code>.</p>
</li>
</ul>
<h3><a class="header" href="#12-arena-examples" id="12-arena-examples">1.2. Arena examples</a></h3>
<p>To introduce the context in more detail, we give an example of how several TLA+ expressions are represented in arenas
and SMT.</p>
<p>Consider the following expression:</p>
<pre><code class="language-tla">{ a, b, c } \union { d, e }
</code></pre>
<p>Let's denote the arguments of the set union to be <code>S</code> and <code>T</code>. In the current arena representation, the rewriting
rule <code>SetCtorRule</code> creates the following SMT constants (assuming that <code>a, ..., e</code> were translated to arena cells):</p>
<ul>
<li>
<p>Two cells <code>c_l</code> and <code>c_r</code> to represent the sets <code>S</code> and <code>T</code>. These cells are backed with two SMT constants of an
uninterpreted sort, which corresponds to the common type of <code>S</code> and <code>T</code>.</p>
</li>
<li>
<p>Five SMT constants of the Boolean sort that express set membership of <code>a, b, c</code> and <code>d, e</code> in <code>S</code> and <code>T</code>,
respectively. The sets <code>S</code> and <code>T</code> are backed with SMT constants of the sort of <code>S</code> and <code>T</code>.</p>
</li>
<li>
<p>One cell <code>c_u</code> to represent the set <code>S \union T</code>.</p>
</li>
<li>
<p>Five Boolean constants of the Boolean sort that express set membership of
<code>a, b, c, d, e</code> in <code>S \union T</code>.</p>
</li>
</ul>
<p>It is obvious that 10 Boolean constants introduced for set membership are completely unnecessary, as we know for sure
that the respective elements belong to the three sets. Moreover, when constructing <code>S \union T</code>, the rule <code>SetCupRule</code>
creates five SMT constraints:</p>
<pre><code class="language-smt">;; a, b, c belong to the union, when they belong to S
(= in_a_u in_a_l)
(= in_b_u in_b_l)
(= in_c_u in_c_l)
;; d and e belong to the union, when they belong to T
(= in_d_u in_d_r)
(= in_e_u in_e_r)
</code></pre>
<h2><a class="header" href="#2-options" id="2-options">2. Options</a></h2>
<ul>
<li>
<p>Keep things as they are.</p>
</li>
<li>
<p>Implement the extension of membership edges presented below.</p>
</li>
</ul>
<h2><a class="header" href="#3-solution" id="3-solution">3. Solution</a></h2>
<h3><a class="header" href="#31-pointers-to-the-elements" id="31-pointers-to-the-elements">3.1. Pointers to the elements</a></h3>
<p>Instead of the current solution in the arenas, which maps a parent cell to a
list of element cells, we propose to map parent cells to membership pointers of
various kinds. To this end, we introduce an abstract edge (the Scala code can
be found in the package <code>at.forsyte.apalache.tla.bmcmt.arena</code>):</p>
<p>https://github.com/apalache-mc/apalache/blob/81e397fadc6f3ce346d8f8a709ebb3715ac57391/tla-bmcmt/src/main/scala/at/forsyte/apalache/tla/bmcmt/arena/ElemPtr.scala#L8-L24</p>
<p>Having an abstract edge, we introduce various case classes. The simplest case
is the <code>FixedElemPtr</code>, which always evaluates to a fixed Boolean value:</p>
<p>https://github.com/apalache-mc/apalache/blob/81e397fadc6f3ce346d8f8a709ebb3715ac57391/tla-bmcmt/src/main/scala/at/forsyte/apalache/tla/bmcmt/arena/ElemPtr.scala#L26-L39</p>
<p>Instances of <code>FixedElemPtr</code> may be used in cases, when the membership is
statically known. For instance, set membership for the sets <code>{1, 2, 3}</code> and
<code>1..100</code> is static (always <code>true</code>) and thus it does not require any additional
variables and constraints in SMT. The same applies to records and tuples.</p>
<p>The next case is element membership that is represented via a Boolean constant
in SMT:</p>
<p>https://github.com/apalache-mc/apalache/blob/81e397fadc6f3ce346d8f8a709ebb3715ac57391/tla-bmcmt/src/main/scala/at/forsyte/apalache/tla/bmcmt/arena/ElemPtr.scala#L41-L64</p>
<p>Instances of <code>SmtConstElemPtr</code> may be used in cases, when set membership can be
encoded via a Boolean constant. Typically, this is needed when the membership
is either to be defined by the solver, or when this constant caches a complex
SMT constraint. For instance, it can be used by <code>CherryPick</code>.</p>
<p>The most general case is represented via an SMT expression, which is encoded in
TLA+ IR:</p>
<p>https://github.com/apalache-mc/apalache/blob/81e397fadc6f3ce346d8f8a709ebb3715ac57391/tla-bmcmt/src/main/scala/at/forsyte/apalache/tla/bmcmt/arena/ElemPtr.scala#L66-L77</p>
<p>Instances of <code>SmtExprElemPtr</code> may be used to encode set membership via SMT
expressions. For instance:</p>
<ul>
<li>
<p>Evaluating an array expression, e.g., via <code>apalacheStoreInFun</code>.</p>
</li>
<li>
<p>Combining several pointers. For instance, when computing <code>{ x \in S: P }</code>,
we would combine set membership in <code>S</code> and the value of <code>P</code> for every <code>x</code>.</p>
</li>
</ul>
<h3><a class="header" href="#32-optimization-1-constant-propagation-via-membership-pointers" id="32-optimization-1-constant-propagation-via-membership-pointers">3.2. Optimization 1: constant propagation via membership pointers</a></h3>
<p>One immediate application of using the new representation is completely SMT-free construction of some of the TLA+
expressions.</p>
<p>Recall the example in <a href="#12-arena-examples">Section 1.2</a>. With the new representation, the set constructor would simply
create five instances of
<code>FixedElemPtr</code> that carry the value <code>true</code>, that is, the elements unconditionally belong to <code>S</code> and <code>T</code>. Further, the
rule <code>SetCupRule</code> would simply copy the five pointers, without propagating anything to SMT.</p>
<p>As a result, we obtain constant propagation of set membership, while keeping the general spirit of the arena-based
encoding.</p>
<h3><a class="header" href="#33-optimization-2-sharing-membership-in-a-powerset" id="33-optimization-2-sharing-membership-in-a-powerset">3.3. Optimization 2: sharing membership in a powerset</a></h3>
<p>Consider the TLA+ operator that constructs the powerset of <code>S</code>, that is, the set
of all subsets of <code>S</code>:</p>
<pre><code class="language-tla">SUBSET S
</code></pre>
<p>Let <code>c_S</code> be the cell that represents the set <code>S</code> and <code>c_1, ..., c_n</code> be the
cells that represent the potential elements of <code>S</code>. Note that in general,
membership of all these cells may be statically unknown. For example, consider
the case when the set <code>S</code> is constructed from the following TLA+ expression:</p>
<pre><code class="language-tla">{
  x \in 1..100:
    \E y \in 1..10:
      y * y = x
}
</code></pre>
<p>In the above example, computation of the predicate is delegated to the SMT solver.</p>
<p>The code in <code>PowSetCtor</code> constructs <code>2^Cardinality(S)</code> sets that contain all subsets of <code>S</code>. The tricky part here is
that some of the elements of <code>S</code> may be outside of <code>S</code>. To deal with that, <code>PowSetCtor</code> constructs cells for each
potential combinations of <code>c_1, ..., c_n</code> and adds membership tests for each of them. For instance, consider the
subset <code>T</code> that is constructed by selecting the indices <code>1, 3, 5</code> of <code>1..n</code>. The constructor will introduce three
constraints:</p>
<pre><code class="language-smt">(= in_c_1_T in_c_1_S)
(= in_c_3_T in_c_3_S)
(= in_c_5_T in_c_5_S)
</code></pre>
<p>Hence, the current encoding introduces <code>2^n</code> SMT constants for the subsets and
<code>n * 2^(n - 1)</code> membership constraints in SMT (thanks to Jure @Kukovec for
telling me the precise formula).</p>
<p>With the new representation, we would simply copy the respective membership
pointers of the set <code>S</code>. This would require us to introduce zero constraints in
the SMT, though we would still introduce <code>2^n</code> SMT constants to represent the
subsets themselves. Note that we would still have to introduce <code>n * 2^(n - 1)</code>
pointers in the arena. But this would be done during the process of rewriting.</p>
<h3><a class="header" href="#34-feature-computing-the-set-of-functions-via-pointer-sharing" id="34-feature-computing-the-set-of-functions-via-pointer-sharing">3.4. Feature: computing the set of functions via pointer sharing</a></h3>
<p>Sometimes, it happens that the model checker has to expand a set of functions
<code>[S -&gt; T]</code>. Such a set contains <code>|T|^|S|</code> functions. Since the model checker works with arenas, it can only construct an arena representation of <code>[S -&gt; T]</code>. To this end, assume that the set <code>S</code> is encoded via cells <code>s_1, ..., s_m</code>,
and the set <code>T</code> is encoded via cells <code>t_1, ..., t_n</code>.</p>
<p>If we wanted to construct <code>[S -&gt; T]</code> in the current encoding, we would have to
introduce a relation for each function in the set <code>[S -&gt; T]</code>. That is, for
every sequence <code>i[1], ..., i[n]</code> over <code>1..n</code>, it would construct the relation
<code>R</code>:</p>
<pre><code>{ &lt;&lt;s_1, t_i[1]&gt;&gt;, ..., &lt;&lt;s_m, t_i[m]&gt;&gt; }
</code></pre>
<p>Let's denote with <code>p_j</code> the pair <code>&lt;&lt;s_j, t_i[j]&gt;&gt;</code> for <code>1 &lt;= j &lt;= m</code>.</p>
<p>Moreover, we would add <code>m</code> membership constraints (per function!) in SMT:</p>
<pre><code>(= in_p_1_R (and in_s_1_S in_t_i[1]_T))
...
(= in_p_m_R (and in_s_m_S in_t_i[m]_T))
</code></pre>
<p>As a result, this encoding would introduce <code>m * n^m</code> constants in SMT and the same number of membership constraints. For
instance, if we have <code>m = 10</code> and <code>n = 5</code>, then we would introduce 90 million constants and constraints!</p>
<p>Using the approach outlined in this ADR, we can simply combine membership pointers of <code>S</code> and <code>T</code> via <code>SmtExprElemPtr</code>.
This would neither introduce SMT constants, nor SMT constraints. Of course, when this set is used in expressions
like <code>\E x \in S: P</code> or <code>\A x \in S: P</code>, the edges will propagate to SMT as constraints.</p>
<h2><a class="header" href="#4-consequences" id="4-consequences">4. Consequences</a></h2>
<!-- Records the results of the decision over the long term.
     Did it work, not work, was changed, upgraded, etc.
-->

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../adr/019adr-harmonize-changelog.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../adr/021rfc-prioritization.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../adr/019adr-harmonize-changelog.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../adr/021rfc-prioritization.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src=".././highlightjs-tlaplus/dist/tlaplus.min.js"></script>
        
        <script type="text/javascript" src=".././theme/highlightTla.js"></script>
        

        

    </body>
</html>
